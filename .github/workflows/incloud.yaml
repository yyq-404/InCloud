name: incloud

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Golang
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev

      - name: Cache Go
        uses: actions/cache@v4
        with:
          path: ~/go
          key: ${{ runner.os }}-go

      - name: Install ProjectDiscovery tools
        run: |
          go install github.com/projectdiscovery/subfinder/v2@latest
          go install github.com/projectdiscovery/dnsx@latest
          go install github.com/projectdiscovery/naabu/v2@latest
          go install github.com/projectdiscovery/httpx@latest
          go install github.com/projectdiscovery/nuclei/v2@latest
          go install github.com/projectdiscovery/mapcidr@latest

      - name: Subfinder - passive DNS
        run: |
          subfinder -dL input/domains.txt \
            -config config/subfinder-config.yaml \
            -silent \
            -o output/passive_subdomains.txt

      - name: dnsx - validate domains
        run: |
          dnsx -l output/passive_subdomains.txt \
            -t 50 \
            -silent \
          | tee output/active_subdomains.txt

      - name: naabu - port scan
        run: |
          naabu -list output/active_subdomains.txt \
            -top-ports 1000 \
            -rate 10000 \
            -silent \
          | tee output/active_ports.txt

      - name: httpx - probe web services
        run: |
          httpx -l output/active_ports.txt \
            -title \
            -silent \
          | tee output/active_urls.txt

      - name: Xray scan
        run: |
          wget -q https://github.com/chaitin/xray/releases/download/1.7.1/xray_linux_amd64.zip
          unzip -o xray_linux_amd64.zip
          chmod +x xray_linux_amd64
          mv xray_linux_amd64 xray

          ./xray webscan \
            --url-file output/active_urls.txt \
            --html-output output/xray.html \
            --json-output output/xray.json || true

      - name: Commit results
        run: |
          git config user.email "makelifemuchsimpler@gmail.com"
          git config user.name "yyq-404"
          git add output || true
          git commit -m "InCloud Report" --allow-empty || true

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
